/**
 *
 * \section COPYRIGHT
 *
 * Copyright 2013-2015 Software Radio Systems Limited
 *
 * \section LICENSE
 *
 * This file is part of the srsLTE library.
 *
 * srsLTE is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of
 * the License, or (at your option) any later version.
 *
 * srsLTE is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * A copy of the GNU Affero General Public License can be found in
 * the LICENSE file in the top-level directory of this distribution
 * and at http://www.gnu.org/licenses/.
 *
 */

#include <math.h>
#include <string.h>
#include "srslte/phy/resampling/resample_arb.h"
#include "srslte/phy/utils/debug.h"
#include "srslte/phy/utils/vector.h"

float srslte_resample_arb_polyfilt[SRSLTE_RESAMPLE_ARB_N][SRSLTE_RESAMPLE_ARB_M] __attribute__((aligned(256))) =
{{0,0.002400347599485495,-0.006922416132556366,0.0179104136912176,0.99453086623794,-0.008521087756729117,0.0008598969867484128,0.0004992625165376107},
{-0.001903604727400391,0.004479591950094871,-0.01525319260830623,0.04647449496926549,0.9910477342662829,-0.03275243420114668,0.008048813755373533,-0.001216900416836847},
{-0.001750442300940216,0.006728826416921727,-0.02407540632178267,0.07708575473589654,0.9841056525667189,-0.05473739187922162,0.01460652754040275,-0.002745266140572769},
{-0.001807302702047332,0.009130494591071001,-0.03332524241797466,0.1096377743266821,0.9737536341125557,-0.07444712408657775,0.0205085154280773,-0.004077596041064956},
{-0.002005048395707184,0.01166717081713966,-0.04292591596219218,0.1440068251440274,0.9600641782991848,-0.09187282739868929,0.02573649090563353,-0.005218582609802016},
{-0.002303606593778858,0.01431549924598744,-0.05279365431190471,0.1800496557331084,0.9431333663677619,-0.107022659158021,0.03028295984887362,-0.006178495199082676},
{-0.002673824939871474,0.01705308556587308,-0.06283262272105428,0.2176066284621515,0.9230793648715676,-0.1199244901666642,0.03414559686566755,-0.006951034565279722},
{-0.003099294850834212,0.01985022208215894,-0.07294100481214681,0.2564996326404178,0.9000412628278351,-0.1306207218667012,0.03733448898243594,-0.007554128492547957},
{-0.003564415127592977,0.02267702927238637,-0.08300660359189582,0.2965368855416621,0.874178327911914,-0.1391710078036285,0.03986356581130199,-0.007992692892036229},
{-0.004060222849803048,0.02549633298710617,-0.09291211362877161,0.3375102453232687,0.8456688916962831,-0.1456479420005528,0.04175429631970297,-0.00827816851803391},
{-0.004574770330592958,0.02827133859849648,-0.1025308044303699,0.379200979038518,0.8147072909915275,-0.1501397816831265,0.04303284689167361,-0.008423951215857236},
{-0.005100453570725489,0.0309593063669097,-0.1117325201826136,0.4213772298764557,0.7815036335229155,-0.1527444636485677,0.0437349357738538,-0.008441129184587313},
{-0.005625340687997995,0.03351877124912608,-0.1203802123857154,0.463798444519773,0.7462810500374923,-0.1535722712206338,0.04389261707032224,-0.008345136869130621},
{-0.006140888413286479,0.03590276234084221,-0.1283350405000867,0.5062161107254219,0.7092744343987509,-0.152741400055636,0.04355110899623683,-0.008147838953503964},
{-0.006634012711933725,0.03806645580467819,-0.1354549138065051,0.5483763739419955,0.6707272107491931,-0.1503798528838644,0.0427502160096194,-0.007865132034489236},
{-0.007094909626785393,0.03996043743797257,-0.1415969539549883,0.5900207719663111,0.6308907308946271,-0.1466186670140106,0.04153829696698895,-0.007508971112586246},
{-0.007508971112586246,0.04153829696698895,-0.1466186670140106,0.6308907308946271,0.5900207719663111,-0.1415969539549883,0.03996043743797257,-0.007094909626785393},
{-0.007865132034489236,0.0427502160096194,-0.1503798528838644,0.6707272107491931,0.5483763739419955,-0.1354549138065051,0.03806645580467819,-0.006634012711933725},
{-0.008147838953503964,0.04355110899623683,-0.152741400055636,0.7092744343987509,0.5062161107254219,-0.1283350405000867,0.03590276234084221,-0.006140888413286479},
{-0.008345136869130621,0.04389261707032224,-0.1535722712206338,0.7462810500374923,0.463798444519773,-0.1203802123857154,0.03351877124912608,-0.005625340687997995},
{-0.008441129184587313,0.0437349357738538,-0.1527444636485677,0.7815036335229155,0.4213772298764557,-0.1117325201826136,0.0309593063669097,-0.005100453570725489},
{-0.008423951215857236,0.04303284689167361,-0.1501397816831265,0.8147072909915275,0.379200979038518,-0.1025308044303699,0.02827133859849648,-0.004574770330592958},
{-0.00827816851803391,0.04175429631970297,-0.1456479420005528,0.8456688916962831,0.3375102453232687,-0.09291211362877161,0.02549633298710617,-0.004060222849803048},
{-0.007992692892036229,0.03986356581130199,-0.1391710078036285,0.874178327911914,0.2965368855416621,-0.08300660359189582,0.02267702927238637,-0.003564415127592977},
{-0.007554128492547957,0.03733448898243594,-0.1306207218667012,0.9000412628278351,0.2564996326404178,-0.07294100481214681,0.01985022208215894,-0.003099294850834212},
{-0.006951034565279722,0.03414559686566755,-0.1199244901666642,0.9230793648715676,0.2176066284621515,-0.06283262272105428,0.01705308556587308,-0.002673824939871474},
{-0.006178495199082676,0.03028295984887362,-0.107022659158021,0.9431333663677619,0.1800496557331084,-0.05279365431190471,0.01431549924598744,-0.002303606593778858},
{-0.005218582609802016,0.02573649090563353,-0.09187282739868929,0.9600641782991848,0.1440068251440274,-0.04292591596219218,0.01166717081713966,-0.002005048395707184},
{-0.004077596041064956,0.0205085154280773,-0.07444712408657775,0.9737536341125557,0.1096377743266821,-0.03332524241797466,0.009130494591071001,-0.001807302702047332},
{-0.002745266140572769,0.01460652754040275,-0.05473739187922162,0.9841056525667189,0.07708575473589654,-0.02407540632178267,0.006728826416921727,-0.001750442300940216},
{-0.001216900416836847,0.008048813755373533,-0.03275243420114668,0.9910477342662829,0.04647449496926549,-0.01525319260830623,0.004479591950094871,-0.001903604727400391},
{0.0004992625165376107,0.0008598969867484128,-0.008521087756729117,0.99453086623794,0.0179104136912176,-0.006922416132556366,0.002400347599485495,0}};



 float srslte_resample_arb_polyfilt_35 [SRSLTE_RESAMPLE_ARB_N_35][SRSLTE_RESAMPLE_ARB_M] __attribute__((aligned(256))) =
 {{0.000002955485215,  0.000657994314549,  -0.033395686652146,   0.188481383863832,  0.704261032406613,   0.171322660416961,  -0.032053439082436,   0.000722236729272},
{0.000003596427925,   0.000568080243211,  -0.034615802155152,   0.206204344739138,   0.702921418438421,   0.154765509342932,  -0.030612377229395,   0.000764085430796},
{0.000005121937258,  0.000449039680445,  -0.035689076986744,   0.224449928603191,  0.700248311996698,   0.138842912406449,  -0.029094366813032,   0.000786624971348},
{0.000007718609465,   0.000297261794949,  -0.036589488825594,   0.243172347408947,   0.696253915778072,   0.123583456372980,  -0.027519775698206,   0.000792734165095},
{0.000011575047600,   0.000109005258838,  -0.037289794881918,   0.262321777662990,   0.690956433427623,   0.109011322456059,  -0.025907443019580,   0.000785077624893},
{0.000016882508098,  -0.000119571475197,  -0.037761641428480,   0.281844530653151,   0.684379949985066,   0.095146306185631,  -0.024274662580170,   0.000766100891437},
{0.000023834849457,  -0.000392374989948,  -0.037975689603840,   0.301683254255907,   0.676554274013489,   0.082003866618022,  -0.022637179782782,   0.000738028846774},
{0.000032627688404,  -0.000713336731203,  -0.037901757319987,   0.321777165554580,   0.667514742706306,   0.069595203590358,  -0.021009201268519,   0.000702867092175},
{0.000043456678971,  -0.001086367817537,  -0.037508976943232,   0.342062313218325,   0.657301991568526,   0.057927361522269,  -0.019403416364306,   0.000662405963124},
{0.000056514841640,  -0.001515308860252,  -0.036765968249551,   0.362471868314761,   0.645961690553484,   0.047003358086968,  -0.017831029382043,   0.000618226851332},
{0.000071988882997,  -0.002003874882511,  -0.035641025985104,   0.382936441958648,   0.633544248803284,   0.036822335913581,  -0.016301801765629,   0.000571710504985},
{0.000090054461223,  -0.002555595491550,  -0.034102321191048,   0.403384427938144,   0.620104490387788,   0.027379735343965,  -0.014824103048525,   0.000524046983526},
{0.000110870369116,  -0.003173750525766,  -0.032118115280935,   0.423742368211529,   0.605701303660781,   0.018667486151043,  -0.013404969563367,   0.000476246951838},
{0.000134571624077,  -0.003861301468941,  -0.029656985690720,   0.443935338933583,   0.590397267050922,   0.010674216032341,  -0.012050169836157,   0.000429154010367},
{0.000161261473605,  -0.004620818996097,  -0.026688061757620,   0.463887354454611,   0.574258254277514,   0.003385473622292,  -0.010764275599988,   0.000383457772129},
{0.000191002345063,  -0.005454407088752,  -0.023181269326746,   0.483521786538780,   0.557353022125450,  -0.003216036280022,  -0.009550737376604,   0.000339707414324},
{0.000223805789820,  -0.006363624230896,  -0.019107582435436,   0.502761795874207,   0.539752784028766,  -0.009150207594916,  -0.008411963597610,   0.000298325451050},
{0.000259621494011,  -0.007349402269867,  -0.014439280286493,   0.521530772797177,   0.521530772797177,  -0.014439280286493,  -0.007349402269867,   0.000259621494011},
{0.000298325451050,  -0.008411963597610,  -0.009150207594916,   0.539752784028765,   0.502761795874207,  -0.019107582435436,  -0.006363624230896,   0.000223805789820},
{0.000339707414324,  -0.009550737376604,  -0.003216036280022,   0.557353022125450,   0.483521786538780,  -0.023181269326746,  -0.005454407088752,   0.000191002345063},
{0.000383457772129,  -0.010764275599988,   0.003385473622292,   0.574258254277514,   0.463887354454611,  -0.026688061757620,  -0.004620818996097,   0.000161261473605},
{0.000429154010367,  -0.012050169836157,   0.010674216032341,   0.590397267050922,   0.443935338933583,  -0.029656985690720,  -0.003861301468941,   0.000134571624077},
{0.000476246951838,  -0.013404969563367,   0.018667486151043,   0.605701303660781,   0.423742368211529,  -0.032118115280935,  -0.003173750525766,   0.000110870369116},
{0.000524046983526,  -0.014824103048525,   0.027379735343965,   0.620104490387787,   0.403384427938144,  -0.034102321191048,  -0.002555595491550,   0.000090054461223},
{0.000571710504985,  -0.016301801765629,   0.036822335913581,   0.633544248803283,   0.382936441958648,  -0.035641025985104,  -0.002003874882511,   0.000071988882997},
{0.000618226851332,  -0.017831029382043,   0.047003358086968,   0.645961690553484,   0.362471868314761,  -0.036765968249551,  -0.001515308860252,   0.000056514841640},
{0.000662405963124,  -0.019403416364306,   0.057927361522269,   0.657301991568526,   0.342062313218325,  -0.037508976943232,  -0.001086367817537,   0.000043456678971},
{0.000702867092175,  -0.021009201268519,   0.069595203590358,   0.667514742706306,   0.321777165554580,  -0.037901757319987,  -0.000713336731203,   0.000032627688404},
{0.000738028846774,  -0.022637179782782,   0.082003866618022,   0.676554274013489,   0.301683254255907,  -0.037975689603840,  -0.000392374989948,   0.000023834849457},
{0.000766100891437,  -0.024274662580170,   0.095146306185631,   0.684379949985066,   0.281844530653151,  -0.037761641428480,  -0.000119571475197,   0.000016882508098},
{0.000785077624893,  -0.025907443019580,   0.109011322456059,   0.690956433427623,   0.262321777662990,  -0.037289794881918,   0.000109005258838,   0.000011575047600},
{0.000792734165095,  -0.027519775698206,   0.123583456372980,   0.696253915778072,   0.243172347408947,  -0.036589488825594,   0.000297261794949,   0.000007718609465},
{0.000786624971348,  -0.029094366813032,   0.138842912406449,   0.700248311996698,   0.224449928603191,  -0.035689076986744,   0.000449039680445,   0.000005121937258},
{0.000764085430796,  -0.030612377229395,   0.154765509342932,   0.702921418438421,   0.206204344739138,  -0.034615802155152,   0.000568080243211,   0.000003596427925},
{0.000722236729272,  -0.032053439082436,   0.171322660416961,   0.704261032406613,   0.188481383863832,  -0.033395686652146,   0.000657994314549 ,  0.000002955485215}};



// TODO: use lte/utils/vector.h and Volk
cf_t srslte_resample_arb_dot_prod(cf_t* x, float *y, int len){
  
  /*
  cf_t res = 0+0*I;
  for(int i=0;i<len;i++){
    res += x[i]*y[i];
  }
  */
  
  cf_t res1 = srslte_vec_dot_prod_cfc(x,y,len);
  return res1;
}

// Right-shift our window of samples
void srslte_resample_arb_push(srslte_resample_arb_t *q, cf_t x){
  
  memmove(&q->reg[1], &q->reg[0], (SRSLTE_RESAMPLE_ARB_M-1)*sizeof(cf_t));
  q->reg[0] = x;
}

// Initialize our struct
void srslte_resample_arb_init(srslte_resample_arb_t *q, float rate){
  
  memset(q->reg, 0, SRSLTE_RESAMPLE_ARB_M*sizeof(cf_t));
  q->acc = 0.0;
  q->rate = rate;
  q->step = (1/rate)*SRSLTE_RESAMPLE_ARB_N_35;
}

// Resample a block of input data
int srslte_resample_arb_compute(srslte_resample_arb_t *q, cf_t *input, cf_t *output, int n_in){
  int cnt = 0;
  int n_out = 0;
  int idx = 0;
  cf_t res1,res2;
  float frac = 0;
  while (cnt < n_in) {
    res1 = srslte_resample_arb_dot_prod(q->reg, srslte_resample_arb_polyfilt_35[idx], SRSLTE_RESAMPLE_ARB_M);
    res2 = srslte_resample_arb_dot_prod(q->reg, srslte_resample_arb_polyfilt_35[(idx%SRSLTE_RESAMPLE_ARB_N_35)+1], SRSLTE_RESAMPLE_ARB_M);
   
    if(idx == SRSLTE_RESAMPLE_ARB_N_35){
        *output = res1;
    }else {
        *output = res1 + (res2-res1)*frac;
    }
    

    output++;
    n_out++;
    q->acc += q->step;
    idx = (int)floor(q->acc);
    while(idx >= SRSLTE_RESAMPLE_ARB_N_35){
      q->acc -= SRSLTE_RESAMPLE_ARB_N_35;
      idx -= SRSLTE_RESAMPLE_ARB_N_35;
      if(cnt < n_in)
        srslte_resample_arb_push(q, input[cnt++]);
    }
    frac = q->acc - idx;
    if(frac < 0)
      frac = frac*(-1);
  }
  return n_out;
}
